<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Traffic Sign Detection</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #f5f5f5;
        min-height: 100vh;
        padding: 20px;
        color: #333;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: #2c3e50;
        color: white;
        padding: 24px 30px;
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .header svg {
        width: 32px;
        height: 32px;
      }

      .header h1 {
        font-size: 1.5em;
        font-weight: 600;
      }

      /* Tab Navigation */
      .tab-nav {
        display: flex;
        background: #fff;
        border-bottom: 1px solid #e0e0e0;
      }

      .tab-btn {
        flex: 1;
        padding: 16px 24px;
        background: transparent;
        border: none;
        font-size: 0.95em;
        font-weight: 500;
        color: #666;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        border-bottom: 2px solid transparent;
      }

      .tab-btn:hover {
        background: #f8f9fa;
        color: #333;
      }

      .tab-btn.active {
        color: #2c3e50;
        border-bottom-color: #2c3e50;
      }

      .tab-btn svg {
        width: 20px;
        height: 20px;
      }

      /* Tab Content */
      .tab-content {
        display: none;
        padding: 30px;
      }

      .tab-content.active {
        display: block;
      }

      /* Upload Section */
      .upload-section {
        background: #fafafa;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
        border: 2px dashed #ddd;
        transition: all 0.2s ease;
      }

      .upload-section:hover {
        border-color: #999;
      }

      .upload-section.dragover {
        border-color: #2c3e50;
        background: #f0f4f8;
      }

      .file-input {
        display: none;
      }

      .file-input-button {
        background: #2c3e50;
        color: white;
        padding: 12px 28px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.95em;
        font-weight: 500;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .file-input-button:hover {
        background: #1a252f;
      }

      .file-input-button svg {
        width: 18px;
        height: 18px;
      }

      .detect-button {
        background: #27ae60;
        color: white;
        border: none;
        padding: 12px 28px;
        border-radius: 6px;
        font-size: 0.95em;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-left: 12px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .detect-button:hover {
        background: #219a52;
      }

      .detect-button:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
      }

      .detect-button svg {
        width: 18px;
        height: 18px;
      }

      .upload-hint {
        margin-top: 16px;
        color: #888;
        font-size: 0.9em;
      }

      /* Webcam Section */
      .webcam-section {
        display: flex;
        gap: 24px;
      }

      .webcam-left {
        flex: 1;
      }

      .webcam-right {
        flex: 1;
      }

      .webcam-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 16px;
      }

      .webcam-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 0.9em;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .webcam-btn svg {
        width: 16px;
        height: 16px;
      }

      .start-btn {
        background: #27ae60;
        color: white;
      }

      .start-btn:hover:not(:disabled) {
        background: #219a52;
      }

      .stop-btn {
        background: #e74c3c;
        color: white;
      }

      .stop-btn:hover:not(:disabled) {
        background: #c0392b;
      }

      .capture-btn {
        background: #3498db;
        color: white;
      }

      .capture-btn:hover:not(:disabled) {
        background: #2980b9;
      }

      .webcam-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .video-box {
        background: #1a1a1a;
        border-radius: 8px;
        overflow: hidden;
      }

      .video-box video,
      .video-box canvas {
        display: block;
        width: 100%;
        height: auto;
      }

      #webcam {
        transform: scaleX(-1);
      }

      .video-label {
        background: #2c3e50;
        color: white;
        padding: 10px 16px;
        font-size: 0.9em;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .video-label svg {
        width: 16px;
        height: 16px;
      }

      /* Detection Stats */
      .detection-stats {
        display: flex;
        gap: 20px;
        margin-top: 16px;
      }

      .stat-item {
        background: #f8f9fa;
        padding: 16px 24px;
        border-radius: 6px;
        text-align: center;
        flex: 1;
      }

      .stat-value {
        font-size: 1.8em;
        font-weight: 600;
        color: #2c3e50;
      }

      .stat-label {
        font-size: 0.85em;
        color: #666;
        margin-top: 4px;
      }

      /* Live Detections */
      .live-detections {
        margin-top: 16px;
      }

      .live-detections h4 {
        font-size: 0.95em;
        font-weight: 600;
        color: #333;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .live-detections h4 svg {
        width: 18px;
        height: 18px;
      }

      .detection-list-live {
        max-height: 300px;
        overflow-y: auto;
      }

      .live-detection-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 14px;
        background: #f8f9fa;
        border-radius: 6px;
        margin-bottom: 8px;
        border-left: 3px solid #2c3e50;
      }

      .live-detection-item .class-name {
        font-weight: 500;
        color: #333;
      }

      .live-detection-item .confidence {
        background: #2c3e50;
        color: white;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 0.85em;
        font-weight: 500;
      }

      /* Results Section */
      .results {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
        margin-top: 24px;
      }

      .image-container,
      .detection-info {
        background: #fafafa;
        border-radius: 8px;
        padding: 20px;
      }

      .section-title {
        font-size: 1em;
        font-weight: 600;
        color: #333;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .section-title svg {
        width: 20px;
        height: 20px;
      }

      .image-container img {
        width: 100%;
        height: auto;
        border-radius: 6px;
      }

      .detection-list {
        list-style: none;
        max-height: 400px;
        overflow-y: auto;
      }

      .detection-item {
        background: white;
        margin-bottom: 10px;
        padding: 14px;
        border-radius: 6px;
        border-left: 3px solid #2c3e50;
      }

      .detection-class {
        font-weight: 600;
        color: #333;
      }

      .detection-confidence {
        color: #666;
        margin-top: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.9em;
      }

      .confidence-bar {
        flex: 1;
        height: 6px;
        background: #e0e0e0;
        border-radius: 3px;
        overflow: hidden;
      }

      .confidence-fill {
        height: 100%;
        background: #27ae60;
        border-radius: 3px;
      }

      /* Loading */
      .loading {
        display: none;
        text-align: center;
        padding: 40px;
      }

      .spinner {
        border: 3px solid #e0e0e0;
        border-top: 3px solid #2c3e50;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 0.8s linear infinite;
        margin: 0 auto 16px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Messages */
      .error {
        background: #fdecea;
        color: #c0392b;
        padding: 14px 18px;
        border-radius: 6px;
        margin: 20px 0;
        border-left: 3px solid #e74c3c;
      }

      .success-stats {
        background: #eafaf1;
        color: #1e8449;
        padding: 14px 18px;
        border-radius: 6px;
        margin: 20px 0;
        border-left: 3px solid #27ae60;
        font-weight: 500;
      }

      .no-detections {
        text-align: center;
        color: #888;
        padding: 40px;
      }

      /* Responsive */
      @media (max-width: 900px) {
        .results,
        .webcam-section {
          grid-template-columns: 1fr;
          flex-direction: column;
        }

        .tab-content {
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <circle cx="12" cy="12" r="10" />
          <line x1="12" y1="8" x2="12" y2="12" />
          <line x1="12" y1="16" x2="12.01" y2="16" />
        </svg>
        <h1>Traffic Sign Detection</h1>
      </div>

      <!-- Tab Navigation -->
      <div class="tab-nav">
        <button class="tab-btn active" data-tab="image">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
            <circle cx="8.5" cy="8.5" r="1.5" />
            <polyline points="21 15 16 10 5 21" />
          </svg>
          <span>Upload Ảnh</span>
        </button>
        <button class="tab-btn" data-tab="webcam">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M23 7l-7 5 7 5V7z" />
            <rect x="1" y="5" width="15" height="14" rx="2" ry="2" />
          </svg>
          <span>Webcam Realtime</span>
        </button>
      </div>

      <!-- Tab 1: Image Upload -->
      <div class="tab-content active" id="tab-image">
        <div class="upload-section" id="dropZone">
          <input
            type="file"
            id="fileInput"
            class="file-input"
            accept="image/*"
          />
          <label for="fileInput" class="file-input-button">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
              <polyline points="17 8 12 3 7 8" />
              <line x1="12" y1="3" x2="12" y2="15" />
            </svg>
            Chọn ảnh
          </label>
          <button id="detectButton" class="detect-button" disabled>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <circle cx="11" cy="11" r="8" />
              <line x1="21" y1="21" x2="16.65" y2="16.65" />
            </svg>
            Nhận diện
          </button>
          <p class="upload-hint">
            Kéo thả ảnh vào đây hoặc click để chọn file (JPG, PNG, GIF, BMP -
            tối đa 16MB)
          </p>
        </div>

        <div class="loading" id="loading">
          <div class="spinner"></div>
          <p>Đang xử lý ảnh...</p>
        </div>

        <div id="error" class="error" style="display: none"></div>
        <div id="success" class="success-stats" style="display: none"></div>

        <div class="results" id="results" style="display: none">
          <div class="image-container">
            <div class="section-title">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                <circle cx="8.5" cy="8.5" r="1.5" />
                <polyline points="21 15 16 10 5 21" />
              </svg>
              Kết quả nhận diện
            </div>
            <img id="resultImage" src="" alt="Detection Results" />
          </div>

          <div class="detection-info">
            <div class="section-title">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <line x1="8" y1="6" x2="21" y2="6" />
                <line x1="8" y1="12" x2="21" y2="12" />
                <line x1="8" y1="18" x2="21" y2="18" />
                <line x1="3" y1="6" x2="3.01" y2="6" />
                <line x1="3" y1="12" x2="3.01" y2="12" />
                <line x1="3" y1="18" x2="3.01" y2="18" />
              </svg>
              Các biển báo phát hiện
            </div>
            <ul id="detectionList" class="detection-list"></ul>
          </div>
        </div>
      </div>

      <!-- Tab 2: Webcam -->
      <div class="tab-content" id="tab-webcam">
        <div class="webcam-controls">
          <button class="webcam-btn start-btn" id="startWebcam">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <polygon points="5 3 19 12 5 21 5 3" />
            </svg>
            Bắt đầu
          </button>
          <button class="webcam-btn stop-btn" id="stopWebcam" disabled>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <rect x="6" y="6" width="12" height="12" />
            </svg>
            Dừng
          </button>
          <button class="webcam-btn capture-btn" id="captureBtn" disabled>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"
              />
              <circle cx="12" cy="13" r="4" />
            </svg>
            Chụp ảnh
          </button>
        </div>

        <div class="webcam-section">
          <div class="webcam-left">
            <div class="video-box">
              <div class="video-label">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M23 7l-7 5 7 5V7z" />
                  <rect x="1" y="5" width="15" height="14" rx="2" ry="2" />
                </svg>
                Camera
              </div>
              <video
                id="webcam"
                width="640"
                height="480"
                autoplay
                playsinline
              ></video>
            </div>
            <div class="detection-stats">
              <div class="stat-item">
                <div class="stat-value" id="fpsValue">0</div>
                <div class="stat-label">FPS</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="detectCount">0</div>
                <div class="stat-label">Phát hiện</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="totalFrames">0</div>
                <div class="stat-label">Tổng frame</div>
              </div>
            </div>
          </div>

          <div class="webcam-right">
            <div class="video-box">
              <div class="video-label">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <polygon points="12 2 2 7 12 12 22 7 12 2" />
                  <polyline points="2 17 12 22 22 17" />
                  <polyline points="2 12 12 17 22 12" />
                </svg>
                Kết quả Detection
              </div>
              <canvas id="outputCanvas" width="640" height="480"></canvas>
            </div>

            <div
              class="live-detections"
              id="liveDetections"
              style="display: none"
            >
              <h4>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <circle cx="12" cy="12" r="10" />
                  <line x1="12" y1="8" x2="12" y2="12" />
                  <line x1="12" y1="16" x2="12.01" y2="16" />
                </svg>
                Biển báo đang phát hiện
              </h4>
              <div class="detection-list-live" id="liveDetectionList"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Tab switching
      const tabBtns = document.querySelectorAll(".tab-btn");
      const tabContents = document.querySelectorAll(".tab-content");

      tabBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          const tabId = btn.dataset.tab;

          tabBtns.forEach((b) => b.classList.remove("active"));
          tabContents.forEach((c) => c.classList.remove("active"));

          btn.classList.add("active");
          document.getElementById("tab-" + tabId).classList.add("active");

          if (tabId === "image" && isStreaming) {
            stopWebcam();
          }
        });
      });

      // ==================== IMAGE UPLOAD ====================
      const fileInput = document.getElementById("fileInput");
      const detectButton = document.getElementById("detectButton");
      const loading = document.getElementById("loading");
      const error = document.getElementById("error");
      const success = document.getElementById("success");
      const results = document.getElementById("results");
      const resultImage = document.getElementById("resultImage");
      const detectionList = document.getElementById("detectionList");
      const dropZone = document.getElementById("dropZone");

      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add("dragover");
      });

      dropZone.addEventListener("dragleave", () => {
        dropZone.classList.remove("dragover");
      });

      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.classList.remove("dragover");
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          fileInput.files = files;
          detectButton.disabled = false;
          hideMessages();
        }
      });

      fileInput.addEventListener("change", function () {
        detectButton.disabled = !(this.files && this.files[0]);
        hideMessages();
      });

      detectButton.addEventListener("click", function () {
        const file = fileInput.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append("file", file);

        showLoading();
        hideMessages();

        fetch("/detect", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            hideLoading();
            if (data.success) {
              showResults(data);
            } else {
              showError(data.error || "Đã xảy ra lỗi");
            }
          })
          .catch((err) => {
            hideLoading();
            showError("Lỗi kết nối: " + err.message);
          });
      });

      function showLoading() {
        loading.style.display = "block";
        results.style.display = "none";
      }

      function hideLoading() {
        loading.style.display = "none";
      }

      function showError(message) {
        error.textContent = message;
        error.style.display = "block";
      }

      function showSuccess(message) {
        success.textContent = message;
        success.style.display = "block";
      }

      function hideMessages() {
        error.style.display = "none";
        success.style.display = "none";
      }
      const LABELS = [
        "Cấm dừng",
        "Cấm đỗ",
        "Cấm quay đầu",
        "Cấm rẽ trái",
        "Cấm rẽ phải",
        "Cấm ô tô",
        "Cấm xe tải",
        "Cấm xe máy",
        "Cấm xe đạp",
        "Cấm đi ngược chiều",
        "Cấm vượt",
        "Giảm tốc độ",
        "Đường cấm",
        "Cấm dừng và đỗ xe",
        "Cấm còi",
        "Hết hạn chế tốc độ",
        "Nguy hiểm khúc cua trái",
        "Nguy hiểm khúc cua phải",
        "Đường cong liên tiếp",
        "Đường hẹp",
        "Đường trơn trượt",
        "Đường giao nhau",
        "Giao nhau có tín hiệu",
        "Giao nhau có đường sắt",
        "Trẻ em qua đường",
        "Người đi bộ",
        "Công trường",
        "Có động vật cắt ngang",
        "Đường xấu",
        "Có gió ngang",
        "Cảnh báo khác",
        "Hiệu lệnh rẽ trái",
        "Hiệu lệnh rẽ phải",
        "Đi thẳng",
        "Đi thẳng hoặc rẽ trái",
        "Đi thẳng hoặc rẽ phải",
        "Đi vòng chướng ngại",
        "Đường dành cho người đi bộ",
        "Đường dành cho xe đạp",
        "Đường dành cho xe máy",
        "Đường dành cho ô tô",
        "Chỉ dẫn bệnh viện",
        "Chỉ dẫn bến xe",
        "Chỉ dẫn trạm xăng",
        "Chỉ dẫn nơi đỗ xe",
        "Chỉ dẫn đường một chiều",
        "Chỉ dẫn đường cấm",
        "Đường ưu tiên",
        "Hết đường ưu tiên",
        "Hết mọi lệnh cấm",
        "Hết mọi hạn chế",
        "Cấm dừng từ 6h đến 18h",
        "Cấm đỗ từ 6h đến 18h",
        "Khu vực trường học",
        "Khu dân cư",
        "Hết khu dân cư",
        "Biển STOP",
        "Nhường đường",
        "Camera phạt nguội",
        "Zone cấm dừng đỗ",
        "Hết zone cấm dừng đỗ",
      ];

      function showResults(data) {
        resultImage.src = "data:image/png;base64," + data.image;

        detectionList.innerHTML = "";
        data.detections.forEach((detection) => {
          const confidence = (detection.confidence * 100).toFixed(1);
          const li = document.createElement("li");
          li.className = "detection-item";
          li.innerHTML = `
            <div class="detection-class">
              ${LABELS[detection.class] || "Không xác định"}
            </div>

            <div class="detection-confidence">
              <span>${confidence}%</span>
              <div class="confidence-bar">
                <div class="confidence-fill" style="width: ${confidence}%"></div>
              </div>
            </div>
          `;
          detectionList.appendChild(li);
        });

        if (data.count > 0) {
          showSuccess(`Phát hiện ${data.count} biển báo giao thông`);
        } else {
          showSuccess("Không phát hiện biển báo nào trong ảnh này");
        }

        results.style.display = "grid";
      }

      // ==================== WEBCAM ====================
      const startBtn = document.getElementById("startWebcam");
      const stopBtn = document.getElementById("stopWebcam");
      const captureBtn = document.getElementById("captureBtn");
      const webcamVideo = document.getElementById("webcam");
      const outputCanvas = document.getElementById("outputCanvas");
      const ctx = outputCanvas.getContext("2d");
      const fpsValue = document.getElementById("fpsValue");
      const detectCount = document.getElementById("detectCount");
      const totalFrames = document.getElementById("totalFrames");
      const liveDetections = document.getElementById("liveDetections");
      const liveDetectionList = document.getElementById("liveDetectionList");

      let isStreaming = false;
      let animationId = null;
      let frameCount = 0;
      let totalFrameCount = 0;
      let lastTime = performance.now();

      // ==================== TEXT TO SPEECH (via Python Backend) ====================
      function announceDetection(className, confidence) {
        fetch("/speak", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            class_name: className,
            confidence: confidence,
          }),
        }).catch((err) => console.error("Speak error:", err));
      }

      startBtn.addEventListener("click", startWebcam);
      stopBtn.addEventListener("click", stopWebcam);
      captureBtn.addEventListener("click", captureFrame);

      async function startWebcam() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { width: 640, height: 480, facingMode: "user" },
          });
          webcamVideo.srcObject = stream;
          isStreaming = true;

          startBtn.disabled = true;
          stopBtn.disabled = false;
          captureBtn.disabled = false;

          frameCount = 0;
          totalFrameCount = 0;
          lastTime = performance.now();

          processFrame();
        } catch (err) {
          alert("Không thể truy cập camera: " + err.message);
        }
      }

      function stopWebcam() {
        isStreaming = false;

        if (animationId) {
          cancelAnimationFrame(animationId);
        }

        const stream = webcamVideo.srcObject;
        if (stream) {
          stream.getTracks().forEach((track) => track.stop());
        }
        webcamVideo.srcObject = null;

        startBtn.disabled = false;
        stopBtn.disabled = true;
        captureBtn.disabled = true;

        ctx.clearRect(0, 0, outputCanvas.width, outputCanvas.height);
        liveDetections.style.display = "none";
      }

      async function processFrame() {
        if (!isStreaming) return;

        frameCount++;
        totalFrameCount++;
        totalFrames.textContent = totalFrameCount;

        const now = performance.now();
        if (now - lastTime >= 1000) {
          fpsValue.textContent = frameCount;
          frameCount = 0;
          lastTime = now;
        }

        const tempCanvas = document.createElement("canvas");
        tempCanvas.width = 640;
        tempCanvas.height = 480;
        const tempCtx = tempCanvas.getContext("2d");

        // Flip horizontally to match the mirrored camera view
        tempCtx.translate(640, 0);
        tempCtx.scale(-1, 1);
        tempCtx.drawImage(webcamVideo, 0, 0, 640, 480);

        try {
          const blob = await new Promise((resolve) =>
            tempCanvas.toBlob(resolve, "image/jpeg", 0.8)
          );
          const formData = new FormData();
          formData.append("file", blob, "frame.jpg");

          const response = await fetch("/detect", {
            method: "POST",
            body: formData,
          });

          const data = await response.json();

          if (data.success) {
            const img = new Image();
            img.onload = () => {
              ctx.drawImage(img, 0, 0, 640, 480);
            };
            img.src = "data:image/png;base64," + data.image;

            detectCount.textContent = data.count;

            if (data.detections && data.detections.length > 0) {
              liveDetections.style.display = "block";
              liveDetectionList.innerHTML = data.detections
                .map(
                  (d) => `
                  <div class="live-detection-item">
                    <span class="class-name">
                      ${LABELS[d.class] || d.name || "Không xác định"}
                    </span>
                    <span class="confidence">
                      ${(d.confidence * 100).toFixed(1)}%
                    </span>
                  </div>
                  `
                )
                .join("");

              // Announce detected signs in Vietnamese
              data.detections.forEach((d) => {
                announceDetection(LABELS[d.class], d.confidence);

              });
            } else {
              liveDetections.style.display = "none";
            }
          }
        } catch (err) {
          console.error("Detection error:", err);
        }

        animationId = requestAnimationFrame(processFrame);
      }

      function captureFrame() {
        const tempCanvas = document.createElement("canvas");
        tempCanvas.width = outputCanvas.width;
        tempCanvas.height = outputCanvas.height;
        const tempCtx = tempCanvas.getContext("2d");
        tempCtx.drawImage(outputCanvas, 0, 0);

        const link = document.createElement("a");
        link.download = `capture_${Date.now()}.png`;
        link.href = tempCanvas.toDataURL("image/png");
        link.click();
      }
    </script>
  </body>
</html>
